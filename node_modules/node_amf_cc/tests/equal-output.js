/*
 * Benchmark node_amf_cc against amflib.
 */
var should = require('should');
var SegfaultHandler = require('segfault-handler');
var sys = require('sys');
var fs = require('fs');

var amfcc = require('../build/Release/node_amf_cc');
var amflib = require('amflib/node-amf/amf');  // npm install amflib

SegfaultHandler.registerHandler();

// load test fixtures
var amfData = {};
[
  'in-move_xy',
  'in-edit_location',
  'out-location_lock_request',
  'out-login_start',
].forEach(function iter(type) {
  amfData[type] = fs.readFileSync('tests/data/amfmsg-' + type + '.bin');
});
var jsonData = {};
[
  'out-ping',
  'out-login_end',
  'out-map_get',
  'out-login_start',
].forEach(function iter(type) {
  jsonData[type] = JSON.parse(fs.readFileSync('tests/data/jsonmsg-' + type + '.json'));
});

jsonData['crash'] = JSON.parse(fs.readFileSync('tests/data/1415575677096-out-login_start.json'));

var deserialize_success = 0;
var deserialize_failure = 0;
Object.keys(amfData).forEach(function (type) {
  var baseline = amflib.deserializer(amfData[type].toString('binary')).readValue(amflib.AMF3); 
  var experiment = amfcc.deserialize(amfData[type].toString('binary')).value;
  try {  
    experiment.should.eql(baseline);
    deserialize_success += 1;
  } catch (e) {
    console.log(e);
    deserialize_failure += 1;
  }
});

var serialize_success = 0;
var serialize_failure = 0;
Object.keys(jsonData).forEach(function (type) {
  console.log(jsonData[type]);
  var baseline = amflib.serializer().writeValue(jsonData[type]);
  var experiment = amfcc.serialize(jsonData[type]);
  try {
    experiment.should.be.exactly(baseline);
    serialize_success += 1;
  } catch (e) {
    //console.log(e);
    console.log(type + " failed: " + experiment.length + " vs " + baseline.length);
    for (var i = 0; i < experiment.length; i++) {
      if (baseline[i] != experiment[i]) {
console.log("dif at pos" + i);
        break;
      }
    }
    serialize_failure += 1;
  }
});
console.log("Deserialize: " + deserialize_success + "/" + (deserialize_success + deserialize_failure));
console.log("serialize: " + serialize_success + "/" + (serialize_success + serialize_failure));

